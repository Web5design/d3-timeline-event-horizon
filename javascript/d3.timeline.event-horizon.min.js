function timeline(a,c){var d=d3.min(c,function(k){return k.start}),b=d3.max(c,function(k){return k.end}),e=d-20,f=b+20;this.ctx=c;var h=[],g=[];for(var j in this.ctx){var i=this.ctx[j].start;i&&$.inArray(i,h)==-1&&h.push(i)}for(j in this.ctx)(i=this.ctx[j].end)&&$.inArray(i,g)==-1&&$.inArray(i,h)==-1&&g.push(i);this.beginnings=h;this.endings=g;this.ctx.unshift({name:"before and after",start:e,end:f});this.container=a;this.min=d;this.max=b;this.padding=20;this.before=e;this.after=f;this.h_years=this.h_labels=
this.w=this.h=this.scale=this.svg=null;this.h_events=40;this.evt=null}
timeline.prototype.setup=function(){var a="#"+this.container,c=$(a).innerWidth(),d=$(a).innerHeight();this.h=d;this.w=c;a="#"+this.container;a=d3.select(a).append("svg");a.attr("width",c);a.attr("height",d);c=d3.scale.linear().domain([this.before,this.after]).range([0,c]);this.svg=a;this.scale=c;a=d=c=0;if(this.evt){if(this.evt.start_prefix){var b=this.measure_text(this.evt.start_prefix+" ");a=Math.max(a,b.width)}if(this.evt.end_prefix){b=this.measure_text(this.evt.end_prefix+" ");a=Math.max(a,b.width)}if(this.evt.echo_prefix){b=
this.measure_text(this.evt.echo_prefix+" ");a=Math.max(a,b.width)}}for(var e in this.ctx){b=this.measure_text(this.ctx[e].name);c=Math.max(b.width,c);b=this.measure_text(this.ctx[e].start);d=Math.max(b.width+a,d)}this.h_labels=Math.ceil(c);this.h_years=Math.ceil(d);this.h=this.h_labels+this.h_events+this.h_years;this.svg.attr("height",this.h)};timeline.prototype.redraw=function(){d3.select("#timeline").select("svg").remove();this.draw(this.evt)};
timeline.prototype.draw=function(a){if(a)this.evt=a;this.setup();this.draw_event_blocks();this.draw_beginnings();this.draw_endings();this.draw_ctx();this.draw_evt()};
timeline.prototype.draw_event_blocks=function(){var a=this.scale,c=this.max,d=this.h,b=this.h_events,e=this.h_years;this.svg.selectAll("rect-fill").data(this.ctx).enter().append("rect").attr("x",function(f){return a(f.start)}).attr("y",function(){return d-(e+b)}).attr("width",function(f){if(f.end==0)f.end=c;return a(f.end)-a(f.start)}).attr("height",function(){return b}).attr("class",function(f){var h=["timeline-block"];f.name=="before and after"&&h.push("timeline-before-after");return h.join(" ")}).attr("id",
function(f){return"event-"+f.start+"-"+f.end})};
timeline.prototype.draw_beginnings=function(){var a=this,c=this.scale,d=this.h;this.svg.selectAll("text-beginnings").data(this.beginnings).enter().append("text").text(function(b){if(!a.evt)return b;var e=a.evt.start,f=a.evt.end,h=a.evt.echo,g=e<b?c(b)-c(e):c(e)-c(b);if((g=!e||g>=18?1:0)&&f){g=e<b?c(b)-c(f):c(f)-c(b);g=g<=-18||g>=18?1:0}if(g&&h){g=e<b?c(b)-c(h):c(h)-c(b);g=g<=-18||g>=18?1:0}return g?b:""}).attr("x",function(b){return b=c(b)-12}).attr("y",function(b){b=a.measure_text(b);return d-Math.floor(a.h_years-
b.width)}).attr("transform",function(b){if(b.name!="before and after"){var e=a.measure_text(b);e=Math.floor(a.h_years-e.width);return"rotate("+[-90,c(b),d-e-13].join(",")+")"}}).style("text-anchor","center").attr("id",function(b){return"date-"+b}).attr("class",function(){return"timeline-event timeline-event-year"})};
timeline.prototype.draw_endings=function(){var a=this,c=this.scale,d=this.h;this.svg.selectAll("text-endings").data(this.endings).enter().append("text").text(function(b){if(!a.evt)return b;var e=a.evt.end;if(!e)return b;e=e<b?c(b)-c(e):c(e)-c(b);if((e=e>=18?1:0)&&a.evt.echo){e=a.evt.echo<b?a.scale(b)-a.scale(a.evt.echo):a.scale(a.evt.echo)-a.scale(b);e=e<=-18||e>=18?1:0}return e?b:""}).attr("x",function(b){return b=c(b)-12}).attr("y",function(b){b=a.measure_text(b);return d-Math.floor(a.h_years-b.width)}).attr("transform",
function(b){if(b.name!="before and after"){var e=a.measure_text(b);e=Math.floor(a.h_years-e.width);return"rotate("+[-90,c(b),d-e-13].join(",")+")"}}).style("text-anchor","center").attr("id",function(b){return"date-"+b}).attr("class","timeline-event timeline-event-year-ending")};
timeline.prototype.draw_ctx=function(){var a=this,c=this.scale,d=this.h,b=this.h_years,e=this.h_events;this.svg.selectAll("text-ctx").data(this.ctx).enter().append("text").text(function(f){if(f.name!="before and after")return f.name}).attr("x",function(f){return a.scale(f.start)}).attr("y",function(){return d-(b+e)}).on("mouseover",function(f){if(f.name!="before and after"){var h=f.start,g=f.end,j=d3.select("#date-"+h),i=j.attr("class");j.attr("class",i+" timeline-event-year-hover");j=d3.select("#date-"+
g);i=j.attr("class");j.attr("class",i+" timeline-event-year-hover");a.draw_event_span(h,g);if(a.evt){h=a.evt.start;g=a.evt.end;i=a.evt.echo;if(a.draw_evt_span()&&a.does_overlap(h,g,f.start,f.end))a.draw_span_block(f.start>h?f.start:h,f.end<g?f.end:g,"hover-block");else h&&a.is_between(f.start,f.end,h,6)&&a.draw_arrow(h,"hover-arrow-start-"+h,"youarehere");i>a.min&&i<a.max&&a.is_between(f.start,f.end,i,6)&&a.draw_arrow(i,"hover-arrow-echo-"+i,"echo")}}}).on("mouseout",function(f){if(f.name!="before and after"){var h=
f.start;f=f.end;$("#span-"+h+"-"+f+"-rect").remove();var g=d3.select("#date-"+h);h=g.attr("class").replace("timeline-event-year-hover","");g.attr("class",h);f=d3.select("#date-"+f);h=f.attr("class").replace("timeline-event-year-hover","");f.attr("class",h);if(a.evt){h=a.evt.start;f=a.evt.echo;a.remove_arrow("hover-arrow-start-"+h);a.remove_arrow("hover-arrow-echo-"+f);$("#hover-block").remove()}}}).style("text-anchor","center").attr("transform",function(f){if(f.name!="before and after")return"rotate("+
[-90,c(f.start),d-(b+e+10)].join(",")+")"}).attr("class","timeline-event timeline-event-item")};
timeline.prototype.draw_evt=function(){if(this.evt){var a=this.evt.start,c=this.evt.end,d=a,b=c;if(d<this.min)d=this.min-this.padding/2;if(c==0)b=(new Date).getYear()+1900;else if(b>this.max)b=this.max+this.padding/2;var e=this.scale(d),f=this.scale(d)-this.scale(b);f=f<=-18||f>=18?1:0;var h=null;if(this.evt.echo){h=d<this.evt.echo?this.scale(d)-this.scale(this.evt.echo):this.scale(this.evt.echo)-this.scale(d);h=h<=-18||h>=18?1:0}if(a){var g=a;if(this.evt.start_prefix)g=this.evt.start_prefix+" "+
a;var j=this.measure_text(g,"timeline-event timeline-event-evt timeline-evt-start"),i=Math.floor(this.h_years-j.width);i-=12;var k=this.h;j=k-i;this.svg.append("text").text(g).attr("x",e+1.5).attr("y",j).attr("transform",function(){return"rotate("+[-90,e,k-i-3].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-evt timeline-evt-start")}if(c&&c!=a&&c>this.min&&f){g=c;if(this.evt.end_prefix)g=this.evt.end_prefix+" "+c;j=this.measure_text(g,"timeline-event timeline-event-evt timeline-evt-start");
i=Math.floor(this.h_years-j.width);i-=9;k=this.h;j=k-i;e=this.scale(b);this.svg.append("text").text(g).attr("x",e-1.5).attr("y",j).attr("transform",function(){return"rotate("+[-90,e,k-i-3].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-year-ending timeline-event-evt timeline-event-evt-end")}if(this.evt.echo&&this.evt.echo!=a&&h){g=this.evt.echo;if(this.evt.echo_prefix)g=this.evt.echo_prefix+" "+g;j=this.measure_text(g,"timeline-event timeline-event-evt timeline-evt-start");
i=Math.floor(this.h_years-j.width);i-=9;k=this.h;j=k-i;e=this.scale(this.evt.echo);this.svg.append("text").text(g).attr("x",e-1.5).attr("y",j).attr("transform",function(){return"rotate("+[-90,e,k-i-3].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-evt timeline-evt-start")}if(this.draw_evt_span()){this.draw_span_line(d,b);this.draw_span_block(d,b)}else a&&this.draw_arrow(d,"youarehere");this.evt.echo&&this.draw_arrow(this.evt.echo,"echo","echo")}};
timeline.prototype.draw_arrow=function(a,c,d){var b=["youarehere"];a<this.min&&b.push("youarehere-before");a>this.max&&b.push("youarehere-after");b=b.join(" ");if(d)b+=" "+d;a=this.scale(a);d=this.h-(this.h_years+this.h_events);var e=this.h-(this.h_years+6),f=this.h-(this.h_years+4);this.svg.append("line").attr("id",c+"-shaft").attr("x1",a).attr("x2",a).attr("y1",d).attr("y2",e).attr("class",b);a=["M"+(a-6)+","+(f-6),"L"+a+","+f,"L"+(a+6)+","+(f-6),"Z"];this.svg.append("path").attr("id",c+"-head").attr("d",
a.join(" ")).attr("class",b)};timeline.prototype.remove_arrow=function(a){$("#"+a+"-head").remove();$("#"+a+"-shaft").remove()};timeline.prototype.draw_event_span=function(a,c,d){d="span-"+a+"-"+c+"-rect";a=this.scale(a);c=this.scale(c)-a;this.svg.append("rect").attr("id",d).attr("x",a).attr("y",this.h-(this.h_years+this.h_events)).attr("height",this.h_events).attr("width",c).attr("class","timeline-span-rect")};
timeline.prototype.draw_span_line=function(a,c){var d=this.scale(a),b=this.scale(c);this.svg.append("line").attr("id","thing").attr("x1",d).attr("x2",b).attr("y1",this.h-this.h_years+1.5).attr("y2",this.h-this.h_years+1.5).attr("class","timeline-span-line")};
timeline.prototype.draw_span_block=function(a,c,d){d||(d="span-"+a+"-"+c+"-block");a=this.scale(a);c=this.scale(c)-a;this.svg.append("rect").attr("id",d).attr("x",a).attr("y",this.h-(this.h_years+this.h_events)).attr("height",this.h_events).attr("width",c).attr("class","timeline-item")};timeline.prototype.does_overlap=function(a,c,d,b){if(c>d&&c<b)return 1;if(a>d||c>b)return 1;if(a<d&&c>b)return 1;if(a<d&&c>b)return 1;return 0};
timeline.prototype.is_between=function(a,c,d,b){if(b){a=this.scale(a)-b;c=this.scale(c)+b;d=this.scale(d)}return d>=a&&d<=c?1:0};
timeline.prototype.draw_evt_span=function(){var a=this.evt.start,c=this.evt.end,d=a,b=c;if(d<this.min)d=this.min-this.padding/2;if(c==0)b=(new Date).getYear()+1900;else if(b>this.max)b=this.max+this.padding/2;var e=0;if(a&&d!=b&&b)e=1;if(e&&a<this.min&&c<this.min)e=0;if(e&&this.is_between(this.before,this.min,a)&&this.is_between(this.before,this.min,c))e=0;if(e&&a<this.before&&c<this.before)e=0;if(e&&this.is_between(this.max,this.after,a)&&this.is_between(this.max,this.after,c))e=0;if(e&&a>this.after&&
c>this.after)e=0;return e};timeline.prototype.measure_text=function(a,c){if(!a||a.length===0)return{height:0,width:0};var d=this.svg.append("text").attr({x:-1000,y:-1000}).attr("class",c).text(a+"-"),b=d.node().getBBox();d.remove();return{height:b.height,width:b.width}};
