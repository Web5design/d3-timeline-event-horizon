function timeline(b,d){var c=d3.min(d,function(j){return j.start}),a=d3.max(d,function(j){return j.end}),e=c-20,g=a+20;this.ctx=d;var f=[],h=[];for(var k in this.ctx){var i=this.ctx[k].start;i&&$.inArray(i,f)==-1&&f.push(i)}for(k in this.ctx)(i=this.ctx[k].end)&&$.inArray(i,h)==-1&&$.inArray(i,f)==-1&&h.push(i);this.beginnings=f;this.endings=h;this.ctx.unshift({name:"before and after",start:e,end:g});this.container=b;this.min=c;this.max=a;this.padding=20;this.before=e;this.after=g;this.evt=this.w=
this.h=this.scale=this.svg=null;this.setup()}timeline.prototype.setup=function(){var b="#"+this.container,d=$(b).innerWidth(),c=$(b).innerHeight();this.h=c;this.w=d;b="#"+this.container;b=d3.select(b).append("svg");b.attr("width",d);b.attr("height",c);d=d3.scale.linear().domain([this.before,this.after]).range([0,d]);this.svg=b;this.scale=d};timeline.prototype.redraw=function(){d3.select("#timeline").select("svg").remove();this.setup();this.draw(this.evt)};
timeline.prototype.draw=function(b){if(b)this.evt=b;this.draw_event_blocks();this.draw_beginnings();this.draw_endings();this.draw_ctx();this.draw_evt()};
timeline.prototype.draw_event_blocks=function(){var b=this.scale,d=this.max,c=this.h;this.svg.selectAll("rect-fill").data(this.ctx).enter().append("rect").attr("x",function(a){return b(a.start)}).attr("y",function(){return c-75}).attr("width",function(a){if(a.end==0)a.end=d;return b(a.end)-b(a.start)}).attr("height",function(){return 35}).attr("class",function(a){var e=["timeline-block"];a.name=="before and after"&&e.push("timeline-before-after");return e.join(" ")}).attr("id",function(a){return"event-"+
a.start+"-"+a.end})};
timeline.prototype.draw_beginnings=function(){var b=this,d=this.scale;this.svg.selectAll("text-beginnings").data(this.beginnings).enter().append("text").text(function(c){if(!b.evt)return c;var a=b.evt.start,e=b.evt.end,g=b.evt.echo,f=a<c?d(c)-d(a):d(a)-d(c);if((f=!a||f>=16?1:0)&&e){f=a<c?d(c)-d(e):d(e)-d(c);f=f<=-16||f>=16?1:0}if(f&&g){f=a<c?d(c)-d(g):d(g)-d(c);f=f<=-16||f>=16?1:0}return f?c:""}).attr("x",function(c){return c=d(c)-12}).attr("y",function(){return 195}).attr("transform",function(c){if(c.name!=
"before and after")return"rotate("+[-90,d(c),183].join(",")+")"}).style("text-anchor","center").attr("id",function(c){return"date-"+c}).attr("class",function(){return"timeline-event timeline-event-year"})};
timeline.prototype.draw_endings=function(){var b=this,d=this.scale;this.svg.selectAll("text-endings").data(this.endings).enter().append("text").text(function(c){if(!b.evt)return c;var a=b.evt.end;if(!a)return c;a=a<c?d(c)-d(a):d(a)-d(c);return(a<=-16||a>=16?1:0)?c:""}).attr("x",function(c){return c=d(c)-12}).attr("y",function(){return 195}).attr("transform",function(c){if(c.name!="before and after")return"rotate("+[-90,d(c),183].join(",")+")"}).style("text-anchor","center").attr("id",function(c){return"date-"+
c}).attr("class","timeline-event timeline-event-year-ending")};
timeline.prototype.draw_ctx=function(){var b=this,d=this.scale,c=this.h;this.svg.selectAll("text-ctx").data(this.ctx).enter().append("text").text(function(a){if(a.name!="before and after")return a.name}).attr("x",function(a){return b.scale(a.start)-15}).attr("y",function(){return 110}).on("mouseover",function(a){if(a.name!="before and after"){var e=a.start,g=a.end,f=d3.select("#date-"+e),h=f.attr("class");f.attr("class",h+" timeline-event-year-hover");f=d3.select("#date-"+g);h=f.attr("class");f.attr("class",
h+" timeline-event-year-hover");b.draw_event_span(e,g);if(b.evt){e=b.evt.start;g=b.evt.end;h=b.evt.echo;if(b.draw_evt_span()&&b.does_overlap(e,g,a.start,a.end))b.draw_span_block(a.start>e?a.start:e,a.end<g?a.end:g,"hover-block");else e&&b.is_between(a.start,a.end,e,6)&&b.draw_arrow(e,"hover-arrow-start-"+e,"youarehere");h>b.min&&h<b.max&&b.is_between(a.start,a.end,h,6)&&b.draw_arrow(h,"hover-arrow-echo-"+h,"echo")}}}).on("mouseout",function(a){if(a.name!="before and after"){var e=a.start;a=a.end;
$("#span-"+e+"-"+a+"-rect").remove();var g=d3.select("#date-"+e);e=g.attr("class").replace("timeline-event-year-hover","");g.attr("class",e);a=d3.select("#date-"+a);e=a.attr("class").replace("timeline-event-year-hover","");a.attr("class",e);if(b.evt){e=b.evt.start;a=b.evt.echo;b.remove_arrow("hover-arrow-start-"+e);b.remove_arrow("hover-arrow-echo-"+a);$("#hover-block").remove()}}}).style("text-anchor","center").attr("transform",function(a){if(a.name!="before and after")return"rotate("+[-90,d(a.start),
c-100].join(",")+")"}).attr("class","timeline-event timeline-event-item")};
timeline.prototype.draw_evt=function(){if(this.evt){var b=this.evt.start,d=this.evt.end,c=b,a=d;if(c<this.min)c=this.min-this.padding/2;if(d==0)a=(new Date).getYear()+1900;else if(a>this.max)a=this.max+this.padding/2;var e=this.scale(c),g=this.scale(c)-this.scale(a);g=g<=-16||g>=16?1:0;var f=null;if(this.evt.echo){f=c<this.evt.echo?this.scale(c)-this.scale(this.evt.echo):this.scale(this.evt.echo)-this.scale(c);f=f<0||f>=16?1:0}b&&this.svg.append("text").text(b).attr("x",e-5).attr("y",195).attr("transform",
function(){return"rotate("+[-90,e,190].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-evt timeline-evt-start");if(d&&d!=b&&g){e=this.scale(a);this.svg.append("text").text(d).attr("x",e-5).attr("y",195).attr("transform",function(){return"rotate("+[-90,e,190].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-year-ending timeline-event-evt timeline-event-evt-end")}if(this.evt.echo&&this.evt.echo!=b&&f){e=this.scale(this.evt.echo);
this.svg.append("text").text(this.evt.echo).attr("x",e-5).attr("y",195).attr("transform",function(){return"rotate("+[-90,e,190].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-evt timeline-evt-start")}if(this.draw_evt_span()){this.draw_span_line(c,a);this.draw_span_block(c,a)}else b&&this.draw_arrow(c,"youarehere");this.evt.echo&&this.draw_arrow(this.evt.echo,"echo","echo")}};
timeline.prototype.draw_arrow=function(b,d,c){var a=["youarehere"];b<this.min&&a.push("youarehere-before");b>this.max&&a.push("youarehere-after");a=a.join(" ");if(c)a+=" "+c;b=this.scale(b);c=this.h;this.svg.append("line").attr("id",d+"-shaft").attr("x1",b).attr("x2",b).attr("y1",c-75).attr("y2",c-45).attr("class",a);b=["M"+(b-6)+","+(c-53),"L"+b+","+(c-46),"L"+(b+6)+","+(c-53),"Z"];this.svg.append("path").attr("id",d+"-head").attr("d",b.join(" ")).attr("class",a)};
timeline.prototype.remove_arrow=function(b){$("#"+b+"-head").remove();$("#"+b+"-shaft").remove()};timeline.prototype.draw_event_span=function(b,d,c){c="span-"+b+"-"+d+"-rect";b=this.scale(b);var a=this.h;d=this.scale(d)-b;this.svg.append("rect").attr("id",c).attr("x",b).attr("y",a-75).attr("height",35).attr("width",d).attr("class","timeline-span-rect")};
timeline.prototype.draw_span_line=function(b,d){var c=this.scale(b),a=this.scale(d);this.svg.append("line").attr("id","thing").attr("x1",c).attr("x2",a).attr("y1",this.h-39).attr("y2",this.h-39).attr("class","timeline-span-line")};timeline.prototype.draw_span_block=function(b,d,c){c||(c="span-"+b+"-"+d+"-block");b=this.scale(b);var a=this.h;d=this.scale(d)-b;this.svg.append("rect").attr("id",c).attr("x",b).attr("y",a-75).attr("height",35).attr("width",d).attr("class","timeline-item")};
timeline.prototype.does_overlap=function(b,d,c,a){if(d>c&&d<a)return 1;if(b>c||d>a)return 1;if(b<c&&d>a)return 1;if(b<c&&d>a)return 1;return 0};timeline.prototype.is_between=function(b,d,c,a){if(a){b=this.scale(b)-a;d=this.scale(d)+a;c=this.scale(c)}return c>=b&&c<=d?1:0};
timeline.prototype.draw_evt_span=function(){var b=this.evt.start,d=this.evt.end,c=b,a=d;if(c<this.min)c=this.min-this.padding/2;if(d==0)a=(new Date).getYear()+1900;else if(a>this.max)a=this.max+this.padding/2;var e=0;if(b&&c!=a&&a)e=1;if(e&&b<this.min&&d<this.min)e=0;if(e&&this.is_between(this.before,this.min,b)&&this.is_between(this.before,this.min,d))e=0;if(e&&b<this.before&&d<this.before)e=0;if(e&&this.is_between(this.max,this.after,b)&&this.is_between(this.max,this.after,d))e=0;if(e&&b>this.after&&
d>this.after)e=0;return e};
