function timeline(a,d){var c=d3.min(d,function(j){return j.start}),b=d3.max(d,function(j){return j.end}),e=c-20,g=b+20;this.ctx=d;var f=[],h=[];for(var k in this.ctx){var i=this.ctx[k].start;i&&$.inArray(i,f)==-1&&f.push(i)}for(k in this.ctx)(i=this.ctx[k].end)&&$.inArray(i,h)==-1&&$.inArray(i,f)==-1&&h.push(i);this.beginnings=f;this.endings=h;this.ctx.unshift({name:"before and after",start:e,end:g});this.container=a;this.min=c;this.max=b;this.padding=20;this.before=e;this.after=g;this.evt=this.w=
this.h=this.scale=this.svg=null;this.setup()}timeline.prototype.setup=function(){var a="#"+this.container,d=$(a).innerWidth(),c=$(a).innerHeight();this.h=c;this.w=d;a="#"+this.container;a=d3.select(a).append("svg");a.attr("width",d);a.attr("height",c);d=d3.scale.linear().domain([this.before,this.after]).range([0,d]);this.svg=a;this.scale=d};timeline.prototype.redraw=function(){d3.select("#timeline").select("svg").remove();this.setup();this.draw(this.evt)};
timeline.prototype.draw=function(a){if(a)this.evt=a;this.draw_event_blocks();this.draw_beginnings();this.draw_endings();this.draw_ctx();this.draw_evt()};
timeline.prototype.draw_event_blocks=function(){var a=this.scale,d=this.max,c=this.h;this.svg.selectAll("rect-fill").data(this.ctx).enter().append("rect").attr("x",function(b){return a(b.start)}).attr("y",function(){return c-75}).attr("width",function(b){if(b.end==0)b.end=d;return a(b.end)-a(b.start)}).attr("height",function(){return 35}).attr("class",function(b){var e=["timeline-block"];b.name=="before and after"&&e.push("timeline-before-after");return e.join(" ")}).attr("id",function(b){return"event-"+
b.start+"-"+b.end})};
timeline.prototype.draw_beginnings=function(){var a=this,d=this.scale;this.svg.selectAll("text-beginnings").data(this.beginnings).enter().append("text").text(function(c){if(!a.evt)return c;var b=a.evt.start,e=a.evt.end,g=a.evt.echo,f=b<c?d(c)-d(b):d(b)-d(c);if((f=!b||f>=16?1:0)&&e){f=b<c?d(c)-d(e):d(e)-d(c);f=f<=-16||f>=16?1:0}if(f&&g){f=b<c?d(c)-d(g):d(g)-d(c);f=f<=-16||f>=16?1:0}return f?c:""}).attr("x",function(c){return c=d(c)-12}).attr("y",function(){return 195}).attr("transform",function(c){if(c.name!=
"before and after")return"rotate("+[-90,d(c),183].join(",")+")"}).style("text-anchor","center").attr("id",function(c){return"date-"+c}).attr("class",function(){return"timeline-event timeline-event-year"})};
timeline.prototype.draw_endings=function(){var a=this,d=this.scale;this.svg.selectAll("text-endings").data(this.endings).enter().append("text").text(function(c){if(!a.evt)return c;var b=a.evt.end;if(!b)return c;return((b<c?d(c)-d(b):d(b)-d(c))>=16?1:0)?c:""}).attr("x",function(c){return c=d(c)-12}).attr("y",function(){return 195}).attr("transform",function(c){if(c.name!="before and after")return"rotate("+[-90,d(c),183].join(",")+")"}).style("text-anchor","center").attr("id",function(c){return"date-"+
c}).attr("class","timeline-event timeline-event-year-ending")};
timeline.prototype.draw_ctx=function(){var a=this,d=this.scale,c=this.h;this.svg.selectAll("text-ctx").data(this.ctx).enter().append("text").text(function(b){if(b.name!="before and after")return b.name}).attr("x",function(b){return a.scale(b.start)-15}).attr("y",function(){return 110}).on("mouseover",function(b){if(b.name!="before and after"){var e=b.start,g=b.end,f=d3.select("#date-"+e),h=f.attr("class");f.attr("class",h+" timeline-event-year-hover");f=d3.select("#date-"+g);h=f.attr("class");f.attr("class",
h+" timeline-event-year-hover");a.draw_event_span(e,g);if(a.evt){e=a.evt.start;g=a.evt.end;h=a.evt.echo;if(a.draw_evt_span()&&a.does_overlap(e,g,b.start,b.end))a.draw_span_block(b.start>e?b.start:e,b.end<g?b.end:g,"hover-block");else e&&a.is_between(b.start,b.end,e,6)&&a.draw_arrow(e,"hover-arrow-start-"+e,"youarehere");h>a.min&&h<a.max&&a.is_between(b.start,b.end,h,6)&&a.draw_arrow(h,"hover-arrow-echo-"+h,"echo")}}}).on("mouseout",function(b){if(b.name!="before and after"){var e=b.start;b=b.end;
$("#span-"+e+"-"+b+"-rect").remove();var g=d3.select("#date-"+e);e=g.attr("class").replace("timeline-event-year-hover","");g.attr("class",e);b=d3.select("#date-"+b);e=b.attr("class").replace("timeline-event-year-hover","");b.attr("class",e);if(a.evt){e=a.evt.start;b=a.evt.echo;a.remove_arrow("hover-arrow-start-"+e);a.remove_arrow("hover-arrow-echo-"+b);$("#hover-block").remove()}}}).style("text-anchor","center").attr("transform",function(b){if(b.name!="before and after")return"rotate("+[-90,d(b.start),
c-100].join(",")+")"}).attr("class","timeline-event timeline-event-item")};
timeline.prototype.draw_evt=function(){if(this.evt){var a=this.evt.start,d=this.evt.end,c=a,b=d;if(c<this.min)c=this.min-this.padding/2;if(d==0)b=(new Date).getYear()+1900;else if(b>this.max)b=this.max+this.padding/2;var e=this.scale(c),g=this.scale(c)-this.scale(b);g=g<=-16||g>=16?1:0;var f=null;if(this.evt.echo){f=c<this.evt.echo?this.scale(c)-this.scale(this.evt.echo):this.scale(this.evt.echo)-this.scale(c);f=f<0||f>=16?1:0}a&&this.svg.append("text").text(a).attr("x",e-5).attr("y",195).attr("transform",
function(){return"rotate("+[-90,e,190].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-evt timeline-evt-start");if(d&&d!=a&&d>this.min&&g){e=this.scale(b);this.svg.append("text").text(d).attr("x",e-5).attr("y",195).attr("transform",function(){return"rotate("+[-90,e,190].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-year-ending timeline-event-evt timeline-event-evt-end")}if(this.evt.echo&&this.evt.echo!=a&&f){e=this.scale(this.evt.echo);
this.svg.append("text").text(this.evt.echo).attr("x",e-5).attr("y",195).attr("transform",function(){return"rotate("+[-90,e,190].join(",")+")"}).style("text-anchor","center").attr("class","timeline-event timeline-event-evt timeline-evt-start")}if(this.draw_evt_span()){this.draw_span_line(c,b);this.draw_span_block(c,b)}else a&&this.draw_arrow(c,"youarehere");this.evt.echo&&this.draw_arrow(this.evt.echo,"echo","echo")}};
timeline.prototype.draw_arrow=function(a,d,c){var b=["youarehere"];a<this.min&&b.push("youarehere-before");a>this.max&&b.push("youarehere-after");b=b.join(" ");if(c)b+=" "+c;a=this.scale(a);c=this.h;this.svg.append("line").attr("id",d+"-shaft").attr("x1",a).attr("x2",a).attr("y1",c-75).attr("y2",c-45).attr("class",b);a=["M"+(a-6)+","+(c-53),"L"+a+","+(c-46),"L"+(a+6)+","+(c-53),"Z"];this.svg.append("path").attr("id",d+"-head").attr("d",a.join(" ")).attr("class",b)};
timeline.prototype.remove_arrow=function(a){$("#"+a+"-head").remove();$("#"+a+"-shaft").remove()};timeline.prototype.draw_event_span=function(a,d,c){c="span-"+a+"-"+d+"-rect";a=this.scale(a);var b=this.h;d=this.scale(d)-a;this.svg.append("rect").attr("id",c).attr("x",a).attr("y",b-75).attr("height",35).attr("width",d).attr("class","timeline-span-rect")};
timeline.prototype.draw_span_line=function(a,d){var c=this.scale(a),b=this.scale(d);this.svg.append("line").attr("id","thing").attr("x1",c).attr("x2",b).attr("y1",this.h-39).attr("y2",this.h-39).attr("class","timeline-span-line")};timeline.prototype.draw_span_block=function(a,d,c){c||(c="span-"+a+"-"+d+"-block");a=this.scale(a);var b=this.h;d=this.scale(d)-a;this.svg.append("rect").attr("id",c).attr("x",a).attr("y",b-75).attr("height",35).attr("width",d).attr("class","timeline-item")};
timeline.prototype.does_overlap=function(a,d,c,b){if(d>c&&d<b)return 1;if(a>c||d>b)return 1;if(a<c&&d>b)return 1;if(a<c&&d>b)return 1;return 0};timeline.prototype.is_between=function(a,d,c,b){if(b){a=this.scale(a)-b;d=this.scale(d)+b;c=this.scale(c)}return c>=a&&c<=d?1:0};
timeline.prototype.draw_evt_span=function(){var a=this.evt.start,d=this.evt.end,c=a,b=d;if(c<this.min)c=this.min-this.padding/2;if(d==0)b=(new Date).getYear()+1900;else if(b>this.max)b=this.max+this.padding/2;var e=0;if(a&&c!=b&&b)e=1;if(e&&a<this.min&&d<this.min)e=0;if(e&&this.is_between(this.before,this.min,a)&&this.is_between(this.before,this.min,d))e=0;if(e&&a<this.before&&d<this.before)e=0;if(e&&this.is_between(this.max,this.after,a)&&this.is_between(this.max,this.after,d))e=0;if(e&&a>this.after&&
d>this.after)e=0;return e};
